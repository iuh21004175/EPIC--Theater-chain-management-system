# API Duy·ªát/T·ª´ ch·ªëi K·∫ø ho·∫°ch Su·∫•t chi·∫øu

## üìã T·ªïng quan

T√†i li·ªáu n√†y m√¥ t·∫£ chi ti·∫øt v·ªÅ workflow v√† API endpoints cho vi·ªác duy·ªát/t·ª´ ch·ªëi k·∫ø ho·∫°ch su·∫•t chi·∫øu.

## üîÑ Workflow

```
Qu·∫£n l√Ω r·∫°p t·∫°o k·∫ø ho·∫°ch tu·∫ßn
    ‚Üì
KeHoachChiTiet (tinh_trang = 0 - Ch·ªù duy·ªát)
    ‚Üì
Qu·∫£n l√Ω chu·ªói r·∫°p xem x√©t
    ‚Üì
    ‚îú‚îÄ‚îÄ DUY·ªÜT (tinh_trang = 1)
    ‚îÇ     ‚Üì
    ‚îÇ   1. C·∫≠p nh·∫≠t KeHoachChiTiet.tinh_trang = 1
    ‚îÇ   2. T·∫°o record m·ªõi trong SuatChieu (tinh_trang = 1)
    ‚îÇ   3. Ghi log v√†o LogSuatChieu (hanh_dong = 5)
    ‚îÇ     ‚Üì
    ‚îÇ   Su·∫•t chi·∫øu c√≥ th·ªÉ b√°n v√©
    ‚îÇ
    ‚îî‚îÄ‚îÄ T·ª™ CH·ªêI (tinh_trang = 2)
          ‚Üì
        1. C·∫≠p nh·∫≠t KeHoachChiTiet.tinh_trang = 2
        2. L∆∞u ly_do_tu_choi
          ‚Üì
        Qu·∫£n l√Ω r·∫°p c√≥ th·ªÉ ch·ªânh s·ª≠a l·∫°i
```

## üéØ Thi·∫øt k·∫ø d·ªØ li·ªáu

### T·∫°i sao KH√îNG t·∫°o b·∫£ng log m·ªõi?

**Quy·∫øt ƒë·ªãnh: S·ª≠ d·ª•ng l·∫°i b·∫£ng `log_suatchieu` hi·ªán c√≥**

**L√Ω do:**

1. ‚úÖ **T·∫≠p trung log**: T·∫•t c·∫£ nh·∫≠t k√Ω li√™n quan ƒë·∫øn su·∫•t chi·∫øu ·ªü m·ªôt n∆°i
2. ‚úÖ **Tr√°nh d∆∞ th·ª´a**: Kh√¥ng c·∫ßn t·∫°o b·∫£ng m·ªõi v·ªõi c·∫•u tr√∫c t∆∞∆°ng t·ª±
3. ‚úÖ **M·ªü r·ªông d·ªÖ d√†ng**: Th√™m gi√° tr·ªã `hanh_dong = 5` (Duy·ªát t·ª´ k·∫ø ho·∫°ch)
4. ‚úÖ **T∆∞∆°ng th√≠ch**: C√πng c·∫•u tr√∫c v·ªõi log su·∫•t chi·∫øu th∆∞·ªùng

### C·∫•u tr√∫c b·∫£ng

#### KeHoachChiTiet
```sql
CREATE TABLE `kehoach_chitiet` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `id_kehoach` INT NOT NULL,
  `id_phim` INT NOT NULL,
  `id_phongchieu` INT NOT NULL,
  `batdau` DATETIME NOT NULL,
  `ketthuc` DATETIME NOT NULL,
  `tinh_trang` TINYINT(1) DEFAULT 0 COMMENT '0-Ch·ªù duy·ªát, 1-ƒê√£ duy·ªát, 2-T·ª´ ch·ªëi',
  `ly_do_tu_choi` TEXT NULL COMMENT 'L√Ω do t·ª´ ch·ªëi',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### LogSuatChieu (C·∫≠p nh·∫≠t)
```sql
-- Th√™m gi√° tr·ªã m·ªõi cho hanh_dong:
-- 0 - T·∫°o
-- 1 - C·∫≠p nh·∫≠t
-- 2 - X√≥a
-- 3 - Duy·ªát (su·∫•t chi·∫øu th∆∞·ªùng)
-- 4 - T·ª´ ch·ªëi (su·∫•t chi·∫øu th∆∞·ªùng)
-- 5 - Duy·ªát t·ª´ k·∫ø ho·∫°ch (M·ªöI)
```

## üöÄ API Endpoints

### 1. Duy·ªát su·∫•t chi·∫øu ƒë∆°n l·∫ª

**Endpoint:** `POST /api/ke-hoach-suat-chieu/{id}/duyet`

**Quy·ªÅn:** Qu·∫£n l√Ω chu·ªói r·∫°p

**M√¥ t·∫£:** Duy·ªát m·ªôt su·∫•t chi·∫øu trong k·∫ø ho·∫°ch, t·∫°o su·∫•t chi·∫øu th·ª±c t·∫ø

**Request:**
```http
POST /api/ke-hoach-suat-chieu/123/duyet
Content-Type: application/json
```

**Response th√†nh c√¥ng:**
```json
{
  "success": true,
  "message": "Duy·ªát su·∫•t chi·∫øu trong k·∫ø ho·∫°ch th√†nh c√¥ng",
  "data": {
    "ke_hoach_chi_tiet": {
      "id": 123,
      "id_kehoach": 45,
      "id_phim": 10,
      "id_phongchieu": 5,
      "batdau": "2025-10-15 14:00:00",
      "ketthuc": "2025-10-15 16:30:00",
      "tinh_trang": 1,
      "ly_do_tu_choi": null
    },
    "suat_chieu": {
      "id": 789,
      "id_phim": 10,
      "id_phongchieu": 5,
      "batdau": "2025-10-15 14:00:00",
      "ketthuc": "2025-10-15 16:30:00",
      "tinh_trang": 1
    }
  }
}
```

**Response l·ªói:**
```json
{
  "success": false,
  "message": "Su·∫•t chi·∫øu n√†y ƒë√£ ƒë∆∞·ª£c duy·ªát tr∆∞·ªõc ƒë√≥"
}
```

**H√†nh ƒë·ªông:**
1. C·∫≠p nh·∫≠t `KeHoachChiTiet.tinh_trang = 1`
2. X√≥a `KeHoachChiTiet.ly_do_tu_choi` (n·∫øu c√≥)
3. T·∫°o record m·ªõi trong `SuatChieu` v·ªõi `tinh_trang = 1`
4. Ghi log v√†o `LogSuatChieu` v·ªõi `hanh_dong = 5`

**Validation:**
- ‚úÖ Ki·ªÉm tra k·∫ø ho·∫°ch chi ti·∫øt t·ªìn t·∫°i
- ‚úÖ Kh√¥ng cho duy·ªát l·∫°i n·∫øu ƒë√£ duy·ªát (`tinh_trang = 1`)
- ‚úÖ S·ª≠ d·ª•ng transaction ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu

---

### 2. T·ª´ ch·ªëi su·∫•t chi·∫øu

**Endpoint:** `POST /api/ke-hoach-suat-chieu/{id}/tu-choi`

**Quy·ªÅn:** Qu·∫£n l√Ω chu·ªói r·∫°p

**M√¥ t·∫£:** T·ª´ ch·ªëi su·∫•t chi·∫øu trong k·∫ø ho·∫°ch

**Request:**
```http
POST /api/ke-hoach-suat-chieu/123/tu-choi
Content-Type: application/json
```

**Response th√†nh c√¥ng:**
```json
{
  "success": true,
  "message": "T·ª´ ch·ªëi su·∫•t chi·∫øu trong k·∫ø ho·∫°ch th√†nh c√¥ng",
  "data": {
    "id": 123,
    "id_kehoach": 45,
    "id_phim": 10,
    "id_phongchieu": 5,
    "batdau": "2025-10-15 14:00:00",
    "ketthuc": "2025-10-15 16:30:00",
    "tinh_trang": 2
  }
}
```

**Response l·ªói:**
```json
{
  "success": false,
  "message": "Kh√¥ng th·ªÉ t·ª´ ch·ªëi su·∫•t chi·∫øu ƒë√£ ƒë∆∞·ª£c duy·ªát"
}
```

**H√†nh ƒë·ªông:**
1. C·∫≠p nh·∫≠t `KeHoachChiTiet.tinh_trang = 2`
2. KH√îNG t·∫°o su·∫•t chi·∫øu th·ª±c t·∫ø
3. KH√îNG ghi log (ch·ªâ c·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫ø ho·∫°ch)

**Validation:**
- ‚úÖ Ki·ªÉm tra k·∫ø ho·∫°ch chi ti·∫øt t·ªìn t·∫°i
- ‚úÖ Kh√¥ng cho t·ª´ ch·ªëi n·∫øu ƒë√£ duy·ªát (`tinh_trang = 1`)

---

### 3. Duy·ªát to√†n b·ªô tu·∫ßn

**Endpoint:** `POST /api/ke-hoach-suat-chieu/duyet-tuan`

**Quy·ªÅn:** Qu·∫£n l√Ω chu·ªói r·∫°p

**M√¥ t·∫£:** Duy·ªát t·∫•t c·∫£ su·∫•t chi·∫øu ch·ªù duy·ªát trong tu·∫ßn

**Request:**
```http
POST /api/ke-hoach-suat-chieu/duyet-tuan
Content-Type: application/json

{
  "batdau": "2025-10-13",
  "ketthuc": "2025-10-19",
  "id_rap": 5
}
```

**Response th√†nh c√¥ng:**
```json
{
  "success": true,
  "message": "Duy·ªát to√†n b·ªô tu·∫ßn th√†nh c√¥ng",
  "data": {
    "count": 15,
    "suat_chieu": [
      {
        "id": 789,
        "id_phim": 10,
        "id_phongchieu": 5,
        "batdau": "2025-10-15 14:00:00",
        "ketthuc": "2025-10-15 16:30:00",
        "tinh_trang": 1
      },
      // ... 14 su·∫•t chi·∫øu kh√°c
    ]
  }
}
```

**Response kh√¥ng c√≥ g√¨ ƒë·ªÉ duy·ªát:**
```json
{
  "success": true,
  "message": "Kh√¥ng c√≥ su·∫•t chi·∫øu n√†o ch·ªù duy·ªát trong tu·∫ßn n√†y",
  "data": {
    "count": 0,
    "suat_chieu": []
  }
}
```

**H√†nh ƒë·ªông:**
1. T√¨m t·∫•t c·∫£ `KeHoachChiTiet` v·ªõi:
   - `tinh_trang = 0` (Ch·ªù duy·ªát)
   - `batdau BETWEEN [batdau, ketthuc]`
   - `phongChieu.id_rapphim = id_rap` (n·∫øu c√≥)
2. V·ªõi m·ªói su·∫•t chi·∫øu:
   - C·∫≠p nh·∫≠t `tinh_trang = 1`
   - T·∫°o `SuatChieu` m·ªõi
   - Ghi log v·ªõi `hanh_dong = 5`
3. S·ª≠ d·ª•ng transaction cho to√†n b·ªô tu·∫ßn

**Validation:**
- ‚úÖ `batdau` v√† `ketthuc` l√† b·∫Øt bu·ªôc
- ‚úÖ `id_rap` l√† optional (n·∫øu kh√¥ng c√≥ th√¨ duy·ªát t·∫•t c·∫£ r·∫°p)
- ‚úÖ Ch·ªâ duy·ªát su·∫•t chi·∫øu c√≥ `tinh_trang = 0`

---

## üíª Frontend Integration

### JavaScript (duyet-ke-hoach.js)

#### Duy·ªát su·∫•t chi·∫øu ƒë∆°n l·∫ª
```javascript
async function approveShowtime(showtimeId) {
    try {
        showSpinner('ƒêang duy·ªát su·∫•t chi·∫øu...');
        
        const response = await fetch(`${baseUrl}/api/ke-hoach-suat-chieu/${showtimeId}/duyet`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Duy·ªát su·∫•t chi·∫øu th√†nh c√¥ng', 'success');
            loadKeHoach(); // Reload danh s√°ch
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('C√≥ l·ªói x·∫£y ra', 'error');
    } finally {
        hideSpinner();
    }
}
```

#### T·ª´ ch·ªëi su·∫•t chi·∫øu
```javascript
async function rejectShowtime(showtimeId) {
    try {
        showSpinner('ƒêang t·ª´ ch·ªëi su·∫•t chi·∫øu...');
        
        const response = await fetch(`${baseUrl}/api/ke-hoach-suat-chieu/${showtimeId}/tu-choi`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('T·ª´ ch·ªëi su·∫•t chi·∫øu th√†nh c√¥ng', 'success');
            loadKeHoach();
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('C√≥ l·ªói x·∫£y ra', 'error');
    } finally {
        hideSpinner();
    }
}
```

#### Duy·ªát to√†n b·ªô tu·∫ßn
```javascript
async function approveAllWeek() {
    const confirm = await showConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát t·∫•t c·∫£ su·∫•t chi·∫øu ch·ªù duy·ªát trong tu·∫ßn?');
    if (!confirm) return;
    
    try {
        showSpinner('ƒêang duy·ªát to√†n b·ªô tu·∫ßn...');
        
        const response = await fetch(`${baseUrl}/api/ke-hoach-suat-chieu/duyet-tuan`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                batdau: formatDate(currentWeekStart),
                ketthuc: formatDate(currentWeekEnd),
                id_rap: currentRapId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`ƒê√£ duy·ªát ${result.data.count} su·∫•t chi·∫øu`, 'success');
            loadKeHoach();
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('C√≥ l·ªói x·∫£y ra', 'error');
    } finally {
        hideSpinner();
    }
}
```

---

## üîí B·∫£o m·∫≠t & Validation

### Backend Validation

#### Service Layer (Sc_KeHoachSuatChieu.php)
```php
// 1. Ki·ªÉm tra t·ªìn t·∫°i
if (!$keHoachChiTiet) {
    throw new \Exception('Kh√¥ng t√¨m th·∫•y su·∫•t chi·∫øu trong k·∫ø ho·∫°ch');
}

// 2. Ki·ªÉm tra tr·∫°ng th√°i
if ($keHoachChiTiet->tinh_trang == 1) {
    throw new \Exception('Su·∫•t chi·∫øu n√†y ƒë√£ ƒë∆∞·ª£c duy·ªát');
}

// 3. Transaction
\Illuminate\Support\Facades\DB::beginTransaction();
try {
    // ... th·ª±c hi·ªán c√°c thay ƒë·ªïi
    \Illuminate\Support\Facades\DB::commit();
} catch (\Exception $e) {
    \Illuminate\Support\Facades\DB::rollBack();
    throw $e;
}
```

### Frontend Validation

```javascript
// 1. Ki·ªÉm tra quy·ªÅn
if (currentUserRole !== 'Qu·∫£n l√Ω chu·ªói r·∫°p') {
    showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y', 'error');
    return;
}

// 2. Ki·ªÉm tra tr·∫°ng th√°i
if (showtime.tinh_trang == 1) {
    showToast('Su·∫•t chi·∫øu ƒë√£ ƒë∆∞·ª£c duy·ªát', 'warning');
    return;
}

// 3. Confirm tr∆∞·ªõc khi duy·ªát h√†ng lo·∫°t
const confirmed = await showConfirm('Duy·ªát t·∫•t c·∫£ su·∫•t chi·∫øu?');
if (!confirmed) return;
```

---

## üìä Database Migration

### Ch·∫°y migration
```bash
# K·∫øt n·ªëi MySQL
mysql -u root -p

# Ch·ªçn database
USE ten_database;

# Ch·∫°y migration
SOURCE i:/Final/Code/ChuoiRapChieuPhim1/database/migrations/add_ly_do_tu_choi_to_kehoach_chitiet.sql;

# Ki·ªÉm tra
DESCRIBE kehoach_chitiet;
```

### Rollback (n·∫øu c·∫ßn)
```sql
ALTER TABLE `kehoach_chitiet` DROP COLUMN `ly_do_tu_choi`;
```

---

## üß™ Testing

### Test Cases

#### 1. Duy·ªát su·∫•t chi·∫øu th√†nh c√¥ng
```
Given: Su·∫•t chi·∫øu c√≥ tinh_trang = 0
When: POST /api/ke-hoach-suat-chieu/{id}/duyet
Then: 
  - KeHoachChiTiet.tinh_trang = 1
  - T·∫°o m·ªõi SuatChieu
  - T·∫°o log v·ªõi hanh_dong = 5
```

#### 2. Kh√¥ng th·ªÉ duy·ªát l·∫°i
```
Given: Su·∫•t chi·∫øu c√≥ tinh_trang = 1
When: POST /api/ke-hoach-suat-chieu/{id}/duyet
Then: HTTP 200 v·ªõi success = false, message = "ƒê√£ ƒë∆∞·ª£c duy·ªát"
```

#### 3. T·ª´ ch·ªëi v·ªõi l√Ω do
```
Given: Su·∫•t chi·∫øu c√≥ tinh_trang = 0
When: POST /api/ke-hoach-suat-chieu/{id}/tu-choi v·ªõi ly_do
Then:
  - KeHoachChiTiet.tinh_trang = 2
  - KeHoachChiTiet.ly_do_tu_choi = ly_do
  - KH√îNG t·∫°o SuatChieu
```

#### 4. Duy·ªát to√†n tu·∫ßn
```
Given: 5 su·∫•t chi·∫øu c√≥ tinh_trang = 0 trong tu·∫ßn
When: POST /api/ke-hoach-suat-chieu/duyet-tuan
Then:
  - T·∫•t c·∫£ 5 su·∫•t c√≥ tinh_trang = 1
  - T·∫°o 5 SuatChieu m·ªõi
  - T·∫°o 5 log v·ªõi hanh_dong = 5
```

---

## üêõ Troubleshooting

### L·ªói th∆∞·ªùng g·∫∑p

#### 1. "Kh√¥ng t√¨m th·∫•y su·∫•t chi·∫øu trong k·∫ø ho·∫°ch"
**Nguy√™n nh√¢n:** ID kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a
**Gi·∫£i ph√°p:** Ki·ªÉm tra ID trong request

#### 2. "Su·∫•t chi·∫øu n√†y ƒë√£ ƒë∆∞·ª£c duy·ªát tr∆∞·ªõc ƒë√≥"
**Nguy√™n nh√¢n:** `tinh_trang = 1`
**Gi·∫£i ph√°p:** Refresh danh s√°ch, kh√¥ng cho ph√©p duy·ªát l·∫°i

#### 3. Transaction rollback
**Nguy√™n nh√¢n:** L·ªói khi t·∫°o SuatChieu ho·∫∑c log
**Gi·∫£i ph√°p:** Ki·ªÉm tra:
- Foreign key constraints
- Required fields trong SuatChieu
- Database connection

#### 4. Log kh√¥ng ƒë∆∞·ª£c ghi
**Nguy√™n nh√¢n:** Thi·∫øu relationship ho·∫∑c d·ªØ li·ªáu phim
**Gi·∫£i ph√°p:** ƒê·∫£m b·∫£o load relationship: `with(['phim', 'phongChieu'])`

---

## üìù Changelog

### Version 1.0 (2025-10-06)
- ‚úÖ Th√™m API duy·ªát/t·ª´ ch·ªëi k·∫ø ho·∫°ch
- ‚úÖ Th√™m c·ªôt `ly_do_tu_choi` v√†o `kehoach_chitiet`
- ‚úÖ Th√™m `hanh_dong = 5` v√†o `log_suatchieu`
- ‚úÖ Implement transaction cho data integrity
- ‚úÖ Validation ƒë·∫ßy ƒë·ªß cho c√°c edge cases
- ‚úÖ Frontend integration v·ªõi duyet-ke-hoach.js

---

## üë• Team

**Developer:** AI Assistant  
**Date:** October 6, 2025  
**Project:** Chu·ªói R·∫°p Chi·∫øu Phim  
**Module:** Qu·∫£n l√Ω k·∫ø ho·∫°ch su·∫•t chi·∫øu
